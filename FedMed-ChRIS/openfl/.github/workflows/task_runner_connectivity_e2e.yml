---
# Task Runner E2E tests to check connectivity.

name: Task_Runner_Connectivity_E2E  # Please do not modify the name as it is used in the composite action

on:
  workflow_call:
    inputs:
      commit_id:
        required: false
        type: string
  workflow_dispatch:

permissions:
  contents: read

env:
  COMMIT_ID: ${{ inputs.commit_id || github.sha }} # use commit_id from the calling workflow

jobs:
  test_gRPC_connectivity:
    name: Task Runner gRPC connectivity (no-op, 3.10)
    if: |
      (github.event_name == 'schedule' && github.repository_owner == 'securefederatedai') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event.pull_request.draft == false)
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      MODEL_NAME: 'no-op'
      PYTHON_VERSION: '3.10'
    steps:
      - name: Checkout OpenFL repository
        id: checkout_openfl
        uses: actions/checkout@v4
        with:
          ref: ${{ env.COMMIT_ID }}

      - name: Pre test run
        uses: ./.github/actions/tr_pre_test_run
        if: ${{ always() }}

      - name: Run Task Runner gRPC connectivity test
        id: run_tests
        run: |
          python -m pytest -s tests/end_to_end/test_suites/task_runner_tests.py -k test_federation_connectivity --model_name ${{ env.MODEL_NAME }}
          echo "Task runner end to end test run completed"

      - name: Post test run
        uses: ./.github/actions/tr_post_test_run
        if: ${{ always() }}
        with:
          test_type: "TLS_Connectivity_gRPC"
          
  test_rest_connectivity:
    name: Task Runner Rest connectivity (no-op, 3.11)
    if: |
      (github.event_name == 'schedule' && github.repository_owner == 'securefederatedai') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event.pull_request.draft == false)
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    env:
      MODEL_NAME: 'no-op'
      PYTHON_VERSION: '3.11'
    steps:
      - name: Checkout OpenFL repository
        id: checkout_openfl
        uses: actions/checkout@v4
        with:
          ref: ${{ env.COMMIT_ID }}

      - name: Pre test run
        uses: ./.github/actions/tr_pre_test_run
        if: ${{ always() }}

      - name: Run Task Runner rest connectivity test
        id: run_tests
        run: |
          python -m pytest -s tests/end_to_end/test_suites/task_runner_tests.py -k test_federation_connectivity --model_name ${{ env.MODEL_NAME }} --tr_rest_protocol
          echo "Task runner end to end test run completed"

      - name: Post test run
        uses: ./.github/actions/tr_post_test_run
        if: ${{ always() }}
        with:
          test_type: "TLS_Connectivity_REST"